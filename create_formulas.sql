-- Создание таблицы Формулы
IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='Формулы' AND xtype='U')
BEGIN
    CREATE TABLE [Формулы] (
        [ID] [int] IDENTITY(1,1) NOT NULL PRIMARY KEY,
        [Название] [nvarchar](255) NOT NULL,
        [КодУсловия] [nvarchar](50) NOT NULL,
        [Условие] [nvarchar](MAX) NOT NULL,
        [ФормулаРасчета] [nvarchar](MAX) NOT NULL,
        [ПунктПриказа] [nvarchar](50) NULL,
        [Комментарий] [nvarchar](MAX) NULL
    );
    
    PRINT 'Таблица Формулы успешно создана';
END
ELSE
BEGIN
    PRINT 'Таблица Формулы уже существует';
END

-- Вставка начальных значений формул
-- Проверяем существует ли хотя бы одна формула
IF NOT EXISTS (SELECT TOP 1 * FROM Формулы)
BEGIN
    -- Лекционные занятия
    INSERT INTO Формулы (Название, КодУсловия, Условие, ФормулаРасчета, ПунктПриказа, Комментарий)
    VALUES (
        'Лекционные занятия', 
        'lecture', 
        'Вид работы = Лекционные занятия', 
        'float(row["Часы"]) * float(row["Количество подгрупп"]) if float(row["Численность потока"]) <= float(row["Контингент по дисциплине"]) else float(row["Часы"]) * float(row["Количество подгрупп"]) * float(row["Контингент по дисциплине"]) / float(row["Численность потока"])',
        '4.3',
        'Формула для расчета часов лекционных занятий'
    );
    
-- Практические и лабораторные занятия по иностранному языку и физ. культуре
    INSERT INTO Формулы (Название, КодУсловия, Условие, ФормулаРасчета, ПунктПриказа, Комментарий)
    VALUES (
        'Практические занятия по ИЯ, ЭФКС и ФКС', 
        'practice_lang_sport', 
        'Вид работы = Практические занятия И Дисциплина = Иностранный язык, Элективные курсы по физической культуре и спорту, Физическая культура и спорт', 
        'float(row["Часы"]) * float(row["Количество подгрупп"]) if float(row["Численность потока"]) <= float(row["Контингент по дисциплине"]) else float(row["Часы"]) * float(row["Количество подгрупп"]) * float(row["Контингент по дисциплине"]) / float(row["Численность потока"]) + float(norms.get("Норма по консультациям для ИЯ, ЭФКС и ФКС", 0)) * float(row["Контингент по дисциплине"]) * float(row["Часы"]) / float(norms.get("Трудоемкость", 1))',
        '4.1',
        'Формула для расчета часов практических занятий по иностранному языку и физкультуре'
    );
    
    -- Обычные практические и лабораторные занятия
    INSERT INTO Формулы (Название, КодУсловия, Условие, ФормулаРасчета, ПунктПриказа, Комментарий)
    VALUES (
        'Практические и лабораторные занятия', 
        'practice_lab', 
        'Вид работы = Практические занятия, Лабораторные занятия, кроме ИЯ, ЭФКС и ФКС', 
        'float(row["Часы"]) * float(row["Количество подгрупп"]) if float(row["Численность потока"]) <= float(row["Контингент по дисциплине"]) else float(row["Часы"]) * float(row["Количество подгрупп"]) * float(row["Контингент по дисциплине"]) / float(row["Численность потока"]) + float(norms.get("Норма по консультациям кроме ИЯ, ЭФКС и ФКС", 0)) * float(row["Контингент по дисциплине"]) * float(row["Часы"]) / float(norms.get("Трудоемкость", 1))',
        '4.2',
        'Формула для расчета часов практических и лабораторных занятий'
    );
    
    -- Экзамены
    INSERT INTO Формулы (Название, КодУсловия, Условие, ФормулаРасчета, ПунктПриказа, Комментарий)
    VALUES (
        'Экзамены', 
        'exam', 
        'Вид работы = Экзамен И (Индекс дисциплины начинается с Б1 или ФТД)', 
        'float(norms.get("Норма по консультациям перед экзаменами", 0)) * float(row["Количество подгрупп"]) + float(norms.get("Норма по экзаменам", 0)) * float(row["Контингент по дисциплине"])',
        '4.6',
        'Формула для расчета часов на экзамены'
    );
    
    -- Кураторство
    INSERT INTO Формулы (Название, КодУсловия, Условие, ФормулаРасчета, ПунктПриказа, Комментарий)
    VALUES (
        'Кураторство', 
        'curator', 
        'Вид работы = Кураторство', 
        'float(row["Часы"]) * float(row["Количество подгрупп"])',
        '5.1',
        'Формула для расчета часов на кураторство'
    );
    
    -- Руководство практиками
    INSERT INTO Формулы (Название, КодУсловия, Условие, ФормулаРасчета, ПунктПриказа, Комментарий)
    VALUES (
        'Руководство практиками', 
        'practice_management', 
        'Индекс дисциплины начинается с Б2 И Вид работы = Руководство (ЗЕТ)', 
        'float(norms.get("Норма по руководству всеми видами практик", 0)) * float(row["Контингент по дисциплине"]) * float(row["Часы"])',
        '4.4',
        'Формула для расчета часов на руководство практиками'
    );
    
    -- Практики с непосредственным участием ППС (архитектура)
    INSERT INTO Формулы (Название, КодУсловия, Условие, ФормулаРасчета, ПунктПриказа, Комментарий)
    VALUES (
        'Практики с участием ППС (архитектура)', 
        'practice_weeks_architecture', 
        'Индекс дисциплины начинается с Б2 И Вид работы = Недели И в имени файла есть 07.03.01', 
        'float(row["Недели"]) * 6 * 6 * float(row["Количество подгрупп"]) if row.get("С непосредственным участием ППС") == "on" else 0',
        '4.4',
        'Формула для расчета часов на практику с участием ППС для направления Архитектура'
    );
    
    -- Практики с непосредственным участием ППС (прочие)
    INSERT INTO Формулы (Название, КодУсловия, Условие, ФормулаРасчета, ПунктПриказа, Комментарий)
    VALUES (
        'Практики с участием ППС', 
        'practice_weeks', 
        'Индекс дисциплины начинается с Б2 И Вид работы = Недели И в имени файла нет 07.03.01', 
        'float(row["Недели"]) * 6 * 6 if row.get("С непосредственным участием ППС") == "on" else 0',
        '4.4',
        'Формула для расчета часов на практику с участием ППС'
    );
    
    -- Проектная деятельность
    INSERT INTO Формулы (Название, КодУсловия, Условие, ФормулаРасчета, ПунктПриказа, Комментарий)
    VALUES (
        'Проектная деятельность', 
        'project_activity', 
        'Вид работы = Руководство проектной деятельности И Дисциплина = Проектная деятельность', 
        'float(norms.get("Норма по зачетам", 0)) * float(row["Контингент по дисциплине"]) + float(norms.get("Норма по руководству проектной деятельностью", 0)) * float(row["Часы"]) * float(row["Количество подгрупп"])',
        '4.7.1',
        'Формула для расчета часов на проектную деятельность'
    );
    
    -- Зачеты
    INSERT INTO Формулы (Название, КодУсловия, Условие, ФормулаРасчета, ПунктПриказа, Комментарий)
    VALUES (
        'Зачеты', 
        'credit', 
        'Вид работы = Зачет или Зачет с оценкой И (Индекс дисциплины начинается с Б1 или ФТД) И Дисциплина != Проектная деятельность', 
        'float(norms.get("Норма по зачетам", 0)) * float(row["Численность потока"])',
        '4.6',
        'Формула для расчета часов на зачеты'
    );
    
    -- Письменные работы
    INSERT INTO Формулы (Название, КодУсловия, Условие, ФормулаРасчета, ПунктПриказа, Комментарий)
    VALUES (
        'Письменные работы', 
        'written_work', 
        'Вид работы = Эссе, Тест, Реферат, Расчетно-графическая работа, Контрольная работа И Форма обучения = Очная форма', 
        'float(norms.get("Норма по письменным работам", 0)) * float(row["Контингент по дисциплине"])',
        '4.7',
        'Формула для расчета часов на проверку письменных работ'
    );
    
    -- Рецензирование ВКР
    INSERT INTO Формулы (Название, КодУсловия, Условие, ФормулаРасчета, ПунктПриказа, Комментарий)
    VALUES (
        'Рецензирование ВКР', 
        'thesis_review', 
        'Вид работы = Рецензирование И Квалификация != бакалавр', 
        'float(norms.get("Норма рецензирования ВКР", 0)) * float(row["Контингент по дисциплине"])',
        '4.9.4',
        'Формула для расчета часов на рецензирование ВКР'
    );
    
    -- Курсовая работа
    INSERT INTO Формулы (Название, КодУсловия, Условие, ФормулаРасчета, ПунктПриказа, Комментарий)
    VALUES (
        'Курсовая работа', 
        'course_work', 
        'Вид работы = Курсовая работа', 
        'float(norms.get("Норма по руководству курсовых работ", 0)) * float(row["Контингент по дисциплине"])',
        '4.7.2',
        'Формула для расчета часов на руководство курсовыми работами'
    );
    
    -- Курсовой проект
    INSERT INTO Формулы (Название, КодУсловия, Условие, ФормулаРасчета, ПунктПриказа, Комментарий)
    VALUES (
        'Курсовой проект', 
        'course_project', 
        'Вид работы = Курсовой проект', 
        'float(norms.get("Норма по руководству курсовым проектом", 0)) * float(row["Контингент по дисциплине"])',
        '4.7.3',
        'Формула для расчета часов на руководство курсовыми проектами'
    );
    
    -- ВКР бакалавр и специалитет
    INSERT INTO Формулы (Название, КодУсловия, Условие, ФормулаРасчета, ПунктПриказа, Комментарий)
    VALUES (
        'ВКР бакалавр и специалитет', 
        'thesis_bachelor', 
        'Вид работы = Руководство (в рамках ГИА) И Квалификация != магистр', 
        'float(norms.get("Норма по руководству подготовки к защите ВКР (бак и спец)", 0)) * float(row["ЗЕТ"] or 0) * float(row["Контингент по дисциплине"])',
        '4.9.1',
        'Формула для расчета часов на руководство ВКР бакалавров и специалистов'
    );
    
    -- ВКР магистратура 1 курс
    INSERT INTO Формулы (Название, КодУсловия, Условие, ФормулаРасчета, ПунктПриказа, Комментарий)
    VALUES (
        'ВКР магистратура 1 курс', 
        'thesis_master_1', 
        'Вид работы = Руководство (в рамках ГИА) И Курс = 1 И Квалификация = магистр', 
        'float(norms.get("Норма по руководству подготовки к защите ВКР (магистр - 1 курс)", 0)) * float(row["Численность потока"])',
        '4.9.2',
        'Формула для расчета часов на руководство ВКР магистров 1 курса'
    );
    
    -- ВКР магистратура 2 курс
    INSERT INTO Формулы (Название, КодУсловия, Условие, ФормулаРасчета, ПунктПриказа, Комментарий)
    VALUES (
        'ВКР магистратура 2 курс', 
        'thesis_master_2', 
        'Вид работы = Руководство (в рамках ГИА) И Курс = 2 И Квалификация = магистр', 
        'float(norms.get("Норма по руководству подготовки к защите ВКР (магистр - 2 курс)", 0)) * float(row["Численность потока"])',
        '4.9.2',
        'Формула для расчета часов на руководство ВКР магистров 2 курса'
    );
    
    -- Экзамен по ВКР магистр очная форма
    INSERT INTO Формулы (Название, КодУсловия, Условие, ФормулаРасчета, ПунктПриказа, Комментарий)
    VALUES (
        'Экзамен по ВКР магистр (очная форма)', 
        'state_exam_master_full', 
        'Вид работы = Экзамен И Квалификация = магистр И Семестр = 4 И Форма обучения = Очная форма И Индекс дисциплины начинается с Б3', 
        '(float(norms.get("Норма по председателю ГЭК", 0)) + float(norms.get("Норма по члену ГЭК", 0)) * float(norms.get("Количество членов ГЭК (При необходимости, можно скорректировать)", 0)) + float(norms.get("Норма по секретарю ГЭК", 0))) * float(row["Численность потока"])',
        '4.10',
        'Формула для расчета часов на экзамен по ВКР магистров (очная форма)'
    );
    
    -- Экзамен по ВКР бакалавр и специалитет очная форма
    INSERT INTO Формулы (Название, КодУсловия, Условие, ФормулаРасчета, ПунктПриказа, Комментарий)
    VALUES (
        'Экзамен по ВКР бакалавр и специалитет (очная форма)', 
        'state_exam_bachelor', 
        'Вид работы = Экзамен И Квалификация != магистр И Форма обучения = Очная форма И Индекс дисциплины начинается с Б3', 
        '(float(norms.get("Норма по председателю ГЭК", 0)) + float(norms.get("Норма по члену ГЭК", 0)) * float(norms.get("Количество членов ГЭК (При необходимости, можно скорректировать)", 0)) + float(norms.get("Норма по секретарю ГЭК", 0))) * float(row["Численность потока"])',
        '4.10',
        'Формула для расчета часов на экзамен по ВКР бакалавров и специалистов (очная форма)'
    );
    
    -- Экзамен по ВКР магистр заочная форма
    INSERT INTO Формулы (Название, КодУсловия, Условие, ФормулаРасчета, ПунктПриказа, Комментарий)
    VALUES (
        'Экзамен по ВКР магистр (заочная форма)', 
        'state_exam_master_part', 
        'Вид работы = Экзамен И Квалификация = магистр И Форма обучения = Заочная форма И Индекс дисциплины начинается с Б3', 
        '(float(norms.get("Норма по председателю ГЭК", 0)) + float(norms.get("Норма по члену ГЭК", 0)) * float(norms.get("Количество членов ГЭК (При необходимости, можно скорректировать)", 0)) + float(norms.get("Норма по секретарю ГЭК", 0))) * float(row["Численность потока"])',
        '4.10',
        'Формула для расчета часов на экзамен по ВКР магистров (заочная форма)'
    );
    
    -- Экзамен по ВКР магистр очно-заочная форма
    INSERT INTO Формулы (Название, КодУсловия, Условие, ФормулаРасчета, ПунктПриказа, Комментарий)
    VALUES (
        'Экзамен по ВКР магистр (очно-заочная форма)', 
        'state_exam_master_mixed', 
        'Вид работы = Экзамен И Квалификация = магистр И Форма обучения = Очно-заочная форма И Индекс дисциплины начинается с Б3', 
        '(float(norms.get("Норма по председателю ГЭК", 0)) + float(norms.get("Норма по члену ГЭК", 0)) * float(norms.get("Количество членов ГЭК (При необходимости, можно скорректировать)", 0)) + float(norms.get("Норма по секретарю ГЭК", 0))) * float(row["Численность потока"])',
        '4.10',
        'Формула для расчета часов на экзамен по ВКР магистров (очно-заочная форма)'
    );
    
    PRINT 'Начальные формулы успешно добавлены';
END
ELSE
BEGIN
    PRINT 'Формулы уже существуют в таблице';
END